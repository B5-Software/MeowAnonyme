<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meow Anonyme - è®¾ç½®ä¸­å¿ƒ</title>
  <link rel="stylesheet" href="../assets/fonts/all.min.css">
  <link rel="stylesheet" href="../styles/settings.css">
</head>
<body>
  <div class="settings-container">
    <div class="settings-header">
      <h1 class="settings-title">è®¾ç½®ä¸­å¿ƒ</h1>
      <button class="close-btn" id="close-settings" title="å…³é—­">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>    <div class="settings-content">
      <!-- å¤–è§‚è®¾ç½® -->
      <div class="settings-section">
        <h2 class="section-title">
          <i class="fa-solid fa-palette"></i>
          å¤–è§‚è®¾ç½®
        </h2>
        <div class="form-group">
          <label>ä¸»é¢˜æ¨¡å¼</label>
          <div class="radio-group">
            <label class="radio-item">
              <input type="radio" name="theme" value="system">
              <span>ğŸŒ“ è·Ÿéšç³»ç»Ÿ</span>
            </label>
            <label class="radio-item">
              <input type="radio" name="theme" value="light">
              <span>â˜€ï¸ æµ…è‰²æ¨¡å¼</span>
            </label>
            <label class="radio-item">
              <input type="radio" name="theme" value="dark">
              <span>ğŸŒ™ æ·±è‰²æ¨¡å¼</span>
            </label>
          </div>
        </div>        <div class="form-group">
          <label>ä¸»é¢˜è‰²</label>
          <div class="color-group">
            <button class="color-btn" data-color="#4ecdc4" style="background: #4ecdc4;" title="é»˜è®¤é’è‰²"></button>
            <button class="color-btn" data-color="#ff6b6b" style="background: #ff6b6b;" title="çŠç‘šçº¢"></button>
            <button class="color-btn" data-color="#4dabf7" style="background: #4dabf7;" title="å¤©ç©ºè“"></button>
            <button class="color-btn" data-color="#69db7c" style="background: #69db7c;" title="è–„è·ç»¿"></button>
            <button class="color-btn" data-color="#ffd43b" style="background: #ffd43b;" title="é˜³å…‰é»„"></button>
            <button class="color-btn" data-color="#da77f2" style="background: #da77f2;" title="ç´«ç½—å…°"></button>
            <input type="color" id="custom-color-picker" title="è‡ªå®šä¹‰é¢œè‰²" style="width: 40px; height: 40px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; -webkit-app-region: no-drag;">
          </div>
        </div>
      </div>

      <!-- æµè§ˆè®¾ç½® -->
      <div class="settings-section">
        <h2 class="section-title">
          <i class="fa-solid fa-globe"></i>
          æµè§ˆè®¾ç½®
        </h2>
        <div class="form-group">
          <label>ä¸»é¡µåœ°å€</label>
          <input type="text" id="homepage-input" placeholder="https://www.bing.com/">
        </div>
        <div class="form-group">
          <label>æœç´¢å¼•æ“</label>
          <select id="search-engine">
            <option value="bing">Bing</option>
            <option value="google">Google</option>
            <option value="duckduckgo">DuckDuckGo</option>
            <option value="startpage">Startpage</option>
            <option value="searx">SearX</option>
            <option value="custom">è‡ªå®šä¹‰</option>
          </select>
        </div>
        <div class="form-group" id="custom-search-group" style="display: none;">
          <label>è‡ªå®šä¹‰æœç´¢URL</label>
          <input type="text" id="custom-search-url" placeholder="https://example.com/search?q=%s">
          <small style="color: var(--text-secondary); font-size: 12px;">ä½¿ç”¨ %s ä½œä¸ºæœç´¢è¯å ä½ç¬¦</small>
        </div>
      </div>

      <!-- Torè¿æ¥ -->
      <div class="settings-section">
        <h2 class="section-title">
          <i class="fa-solid fa-shield-halved"></i>
          Tor è¿æ¥
        </h2>
        <div class="form-group">
          <div class="tor-status-container">
            <div class="tor-switch-container">
              <label class="tor-switch">
                <input type="checkbox" id="tor-switch">
                <span class="tor-slider"></span>
              </label>
              <span id="tor-status-text">å¯åŠ¨ Tor æœåŠ¡</span>
            </div>
            <div class="tor-progress-container" id="tor-progress-container" style="display: none;">
              <div class="tor-progress-bar">
                <div class="tor-progress-fill" id="tor-progress-fill"></div>
              </div>
              <div class="tor-progress-text" id="tor-progress-text">æ­£åœ¨å¯åŠ¨...</div>
            </div>
          </div>
        </div>
        <div class="button-group">
          <button id="show-log-btn" class="button-secondary">
            <i class="fa-solid fa-file-lines"></i>
            æŸ¥çœ‹æ—¥å¿—
          </button>
          <button id="clear-data-btn" class="button-danger">
            <i class="fa-solid fa-trash"></i>
            æ¸…é™¤ç—•è¿¹
          </button>
        </div>
      </div>      <!-- ç½‘æ¡¥è®¾ç½® -->
      <div class="settings-section">
        <h2 class="section-title">
          <i class="fa-solid fa-bridge"></i>
          ç½‘æ¡¥é…ç½®
        </h2>
        <div class="form-group">
          <div class="tor-switch-container">
            <label class="tor-switch">
              <input type="checkbox" id="use-bridges-switch">
              <span class="tor-slider"></span>
            </label>
            <span>ä½¿ç”¨ç½‘æ¡¥</span>
          </div>
        </div>        <div class="form-group">
          <label>ç½‘æ¡¥ç±»å‹</label>
          <select id="bridge-type">
            <option value="obfs4">obfs4 (éœ€è¦æ‰‹åŠ¨æ·»åŠ åœ°å€)</option>
            <option value="snowflake">snowflake (å†…ç½®é…ç½®)</option>
            <option value="meek-azure">meek-azure (å†…ç½®é…ç½®)</option>
          </select>
        </div>
        <div class="bridge-list" id="bridge-list"></div>
        <div class="input-group" id="manual-bridge-input">
          <input type="text" id="bridge-input" placeholder="ç²˜è´´obfs4ç½‘æ¡¥åœ°å€æˆ–æ‰«ç å¯¼å…¥">
          <button id="add-bridge-btn">
            <i class="fa-solid fa-plus"></i>
            æ·»åŠ 
          </button>
          <button id="scan-qr-btn" class="button-secondary">
            <i class="fa-solid fa-qrcode"></i>
            æ‰«ç 
          </button>
        </div>
        <div class="bridge-info" id="bridge-info" style="display: none;">
          <p style="color: var(--text-secondary); font-size: 12px; margin: 8px 0;">
            <i class="fa-solid fa-info-circle"></i>
            å½“å‰é€‰æ‹©çš„ç½‘æ¡¥ç±»å‹æ— éœ€æ‰‹åŠ¨é…ç½®åœ°å€ï¼Œå°†è‡ªåŠ¨ä½¿ç”¨å†…ç½®é…ç½®ã€‚
          </p>
        </div>
        <div class="button-group">
          <button id="save-bridge-config-btn">
            <i class="fa-solid fa-save"></i>
            ä¿å­˜ç½‘æ¡¥é…ç½®
          </button>
          <button id="reset-bridge-config-btn" class="button-secondary">
            <i class="fa-solid fa-rotate-left"></i>
            é‡ç½®ä¸ºå®˜æ–¹é…ç½®
          </button>
        </div>
        <video id="qr-video" class="qr-video" autoplay></video>
      </div>

      <!-- ä»£ç†è®¾ç½® -->
      <div class="settings-section">
        <h2 class="section-title">
          <i class="fa-solid fa-globe"></i>
          ä»£ç†é…ç½®
        </h2>
        <div class="form-group">
          <label class="checkbox-item">
            <input type="checkbox" id="proxy-enabled">
            <span>ä½¿ç”¨å‰ç½®ä»£ç†è¿æ¥ Tor</span>
          </label>
        </div>
        <div class="form-group">
          <label>ä»£ç†åœ°å€</label>
          <input type="text" id="proxy-host" placeholder="">
        </div>
        <div class="form-group">
          <label>ç”¨æˆ·å (å¯é€‰)</label>
          <input type="text" id="proxy-user" placeholder="ç•™ç©ºè¡¨ç¤ºæ— éœ€è®¤è¯">
        </div>
        <div class="form-group">
          <label>å¯†ç  (å¯é€‰)</label>
          <input type="password" id="proxy-pass" placeholder="ç•™ç©ºè¡¨ç¤ºæ— éœ€è®¤è¯">
        </div>
        <div class="button-group">
          <button id="quick-clash" class="button-secondary">
            <i class="fa-solid fa-bolt"></i>
            Clash é»˜è®¤ç«¯å£
          </button>
          <button id="quick-v2ray" class="button-secondary">
            <i class="fa-solid fa-rocket"></i>
            V2Ray é»˜è®¤ç«¯å£
          </button>        </div>
      </div>

      <!-- Torrc é…ç½®ç¼–è¾‘å™¨ -->
      <div class="settings-section">
        <h2 class="section-title">
          <i class="fa-solid fa-file-code"></i>
          Torrc é…ç½®ç¼–è¾‘
        </h2>
        <div class="form-group">
          <div class="torrc-editor-container">
            <div class="torrc-toolbar">
              <button id="reload-torrc" class="button-secondary">
                <i class="fa-solid fa-sync-alt"></i>
                é‡æ–°è½½å…¥
              </button>
              <button id="save-torrc" class="button-primary">
                <i class="fa-solid fa-save"></i>
                ä¿å­˜é…ç½®
              </button>
              <button id="reset-torrc" class="button-danger">
                <i class="fa-solid fa-undo"></i>
                é‡ç½®é»˜è®¤
              </button>
            </div>            <div class="torrc-editor-wrapper">
              <textarea id="torrc-editor" placeholder="Torrc é…ç½®å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º..." rows="15"></textarea>
            </div>
            <div class="torrc-help">
              <p><i class="fa-solid fa-info-circle"></i> æç¤ºï¼š</p>
              <ul>
                <li>ä¿®æ”¹ torrc é…ç½®å¯èƒ½å½±å“ Tor è¿æ¥ï¼Œè¯·è°¨æ…æ“ä½œ</li>
                <li>ä¿å­˜åéœ€è¦é‡å¯ Tor æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆ</li>
                <li>å¦‚é‡é—®é¢˜å¯ç‚¹å‡»"é‡ç½®é»˜è®¤"æ¢å¤é…ç½®</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- å…³äº -->
      <div class="settings-section">
        <h2 class="section-title">
          <i class="fa-solid fa-info-circle"></i>
          å…³äº
        </h2>
        <div class="about-text">
          <p>Meow Anonyme</p>
          <p>ç”± B5-Software å¼€å‘çš„ä¸“æ³¨äºéšç§ä¿æŠ¤çš„æµè§ˆå™¨</p>
          <p style="margin-top: 16px;">
            <strong>Made by B5-Software</strong><br>
            <a href="#" id="github-link" style="color: var(--accent-primary); text-decoration: none;">
              <i class="fa-brands fa-github"></i> è®¿é—® GitHub é¡¹ç›®
            </a>
          </p>
          <p style="font-size: 12px; margin-top: 12px;">ä¸ºäº†æ›´å¥½çš„éšç§ä¿æŠ¤ï¼Œå¯ç”¨Torè¿æ¥è¯•è¯•å–µ~ ğŸ‰</p>
        </div>      </div>
    </div>
  </div>
  <script>
    let currentTheme = 'light';
    
    // åº”ç”¨ä¸»é¢˜
    function applyTheme(theme) {
      currentTheme = theme;
      document.documentElement.setAttribute('data-theme', theme);
    }

    window.addEventListener('DOMContentLoaded', async () => {
      try {
        // è·å–é…ç½®å¹¶åº”ç”¨ä¸»é¢˜
        let config = await window.electronAPI.getConfig();
        applyTheme(config.theme || 'light');

        // å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥è·å–æœ€æ–°é…ç½®
        async function updateConfigValue(updates) {
          config = await window.electronAPI.getConfig();
          const newConfig = { ...config, ...updates };
          await window.electronAPI.updateConfig(newConfig);
          config = newConfig; // æ›´æ–°æœ¬åœ°configå¯¹è±¡
          return newConfig;
        }

        // ç»‘å®šå…³é—­æŒ‰é’®
        document.getElementById('close-settings').addEventListener('click', () => {
          window.close();
        });        // ä¸»é¢˜å•é€‰æŒ‰é’®
        document.querySelectorAll('input[name="theme"]').forEach(radio => {
          radio.checked = (radio.value === config.theme);
          radio.addEventListener('change', async (e) => {
            if (e.target.checked) {
              applyTheme(e.target.value);
              await updateConfigValue({ theme: e.target.value });
              showNotification('ä¸»é¢˜å·²åˆ‡æ¢ï¼');
              // é€šçŸ¥ä¸»çª—å£æ›´æ–°ä¸»é¢˜
              if (window.opener) {
                window.opener.postMessage({ type: 'theme-change', theme: e.target.value }, '*');
              }
            }
          });
        });

        // ä¸»é¢˜è‰²é€‰æ‹©
        const colorBtns = document.querySelectorAll('.color-btn');
        const customColorPicker = document.getElementById('custom-color-picker');
        const currentColor = config.accentColor || '#4ecdc4';
        
        // è®¾ç½®è‡ªå®šä¹‰é¢œè‰²é€‰æ‹©å™¨çš„å€¼
        customColorPicker.value = currentColor;
        
        colorBtns.forEach(btn => {
          const color = btn.dataset.color;
          if (color === currentColor) {
            btn.classList.add('active');
          }
            btn.addEventListener('click', async () => {
            colorBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // æ›´æ–°CSSå˜é‡
            document.documentElement.style.setProperty('--accent-primary', color);
              // ä¿å­˜é…ç½®
            await updateConfigValue({ accentColor: color });
            showNotification('ä¸»é¢˜è‰²å·²æ›´æ–°ï¼');
            
            // é€šçŸ¥ä¸»çª—å£æ›´æ–°ä¸»é¢˜è‰²
            if (window.opener) {
              window.opener.postMessage({ type: 'color-change', color: color }, '*');
            }
          });        });

        // è‡ªå®šä¹‰é¢œè‰²é€‰æ‹©å™¨
        customColorPicker.addEventListener('change', async (e) => {
          const color = e.target.value;
          
          // å–æ¶ˆæ‰€æœ‰é¢„è®¾é¢œè‰²çš„æ¿€æ´»çŠ¶æ€
          colorBtns.forEach(b => b.classList.remove('active'));
          
          // æ›´æ–°CSSå˜é‡
          document.documentElement.style.setProperty('--accent-primary', color);
          
          // ä¿å­˜é…ç½®
          await updateConfigValue({ accentColor: color });
          showNotification('è‡ªå®šä¹‰ä¸»é¢˜è‰²å·²åº”ç”¨ï¼');
          
          // é€šçŸ¥ä¸»çª—å£æ›´æ–°ä¸»é¢˜è‰²
          if (window.opener) {
            window.opener.postMessage({ type: 'color-change', color: color }, '*');
          }
        });        // ä¸»é¡µè®¾ç½®
        const homepageInput = document.getElementById('homepage-input');
        homepageInput.value = config.homepage || 'https://www.bing.com/';
        homepageInput.addEventListener('blur', async () => {
          await updateConfigValue({ homepage: homepageInput.value });
        });

        // æœç´¢å¼•æ“è®¾ç½®
        const searchEngineSelect = document.getElementById('search-engine');
        const customSearchGroup = document.getElementById('custom-search-group');
        const customSearchUrl = document.getElementById('custom-search-url');
        
        searchEngineSelect.value = config.searchEngine || 'bing';
        customSearchUrl.value = config.customSearchUrl || '';
          if (searchEngineSelect.value === 'custom') {
          customSearchGroup.style.display = 'block';
        }
        
        searchEngineSelect.addEventListener('change', async () => {
          if (searchEngineSelect.value === 'custom') {
            customSearchGroup.style.display = 'block';
          } else {
            customSearchGroup.style.display = 'none';
          }
          await updateConfigValue({ searchEngine: searchEngineSelect.value });
        });
        
        customSearchUrl.addEventListener('blur', async () => {
          await updateConfigValue({ customSearchUrl: customSearchUrl.value });
        });

        // Torå¼€å…³
        const torSwitch = document.getElementById('tor-switch');
        const torStatusText = document.getElementById('tor-status-text');
        const torProgressContainer = document.getElementById('tor-progress-container');
          torSwitch.checked = config.torEnabled || false;
        if (torSwitch.checked) {
          updateTorStatus(true);
        } else {
          torStatusText.textContent = 'å¯åŠ¨ Tor æœåŠ¡';
        }
          torSwitch.addEventListener('change', async () => {
          const isEnabled = torSwitch.checked;
          
          if (isEnabled) {
            torStatusText.textContent = 'æ­£åœ¨å¯åŠ¨ Tor...';
            torProgressContainer.style.display = 'block';
            updateTorProgress(0, 'æ­£åœ¨å¯åŠ¨ Tor æœåŠ¡...');
            startProgressMonitoring(); // å¼€å§‹ç›‘æ§è¿›åº¦
            
            try {
              await window.electronAPI.startTor();
              showNotification('Tor æœåŠ¡å·²å¯åŠ¨ï¼');
            } catch (e) {
              showNotification('Tor å¯åŠ¨å¤±è´¥: ' + e.message, 'error');
              torSwitch.checked = false;
              updateTorStatus(false);
              stopProgressMonitoring();
            }
          } else {
            torStatusText.textContent = 'æ­£åœ¨åœæ­¢ Tor...';
            torProgressContainer.style.display = 'none';
            stopProgressMonitoring(); // åœæ­¢ç›‘æ§è¿›åº¦
            
            try {
              await window.electronAPI.stopTor();
              updateTorStatus(false);
              showNotification('Tor æœåŠ¡å·²åœæ­¢ï¼');
            } catch (e) {
              showNotification('Tor åœæ­¢å¤±è´¥: ' + e.message, 'error');
            }
          }
        });

        // GitHubé“¾æ¥
        document.getElementById('github-link').addEventListener('click', (e) => {
          e.preventDefault();
          window.electronAPI.openExternal('https://github.com/B5-Software/MeowAnonyme');
        });

        // ä»£ç†é…ç½®
        const proxyEnabled = document.getElementById('proxy-enabled');
        const proxyHost = document.getElementById('proxy-host');
        const proxyUser = document.getElementById('proxy-user');
        const proxyPass = document.getElementById('proxy-pass');

        proxyEnabled.checked = config.proxyEnabled || false;
        proxyHost.value = config.proxyConfig?.host || '';
        proxyUser.value = config.proxyConfig?.username || '';
        proxyPass.value = config.proxyConfig?.password || '';
        
        proxyEnabled.addEventListener('change', async (e) => {
          await updateConfigValue({ proxyEnabled: e.target.checked });
        });

        proxyHost.addEventListener('blur', async (e) => {
          const currentConfig = await window.electronAPI.getConfig();
          await updateConfigValue({ 
            proxyConfig: { ...currentConfig.proxyConfig, host: e.target.value } 
          });
        });

        proxyUser.addEventListener('blur', async (e) => {
          const currentConfig = await window.electronAPI.getConfig();
          await updateConfigValue({ 
            proxyConfig: { ...currentConfig.proxyConfig, username: e.target.value } 
          });
        });
        
        proxyPass.addEventListener('blur', async (e) => {
          const currentConfig = await window.electronAPI.getConfig();
          await updateConfigValue({ 
            proxyConfig: { ...currentConfig.proxyConfig, password: e.target.value } 
          });
        });
        
        // ç½‘æ¡¥é…ç½®
        const bridgeType = document.getElementById('bridge-type');
        const useBridgesSwitch = document.getElementById('use-bridges-switch');
        const manualBridgeInput = document.getElementById('manual-bridge-input');
        const bridgeInfo = document.getElementById('bridge-info');
        
        bridgeType.value = config.bridgeType || 'obfs4';
        useBridgesSwitch.checked = config.useBridges || false;
        renderBridgeList(config.bridges || []);
        updateBridgeTypeUI(bridgeType.value);
        
        bridgeType.addEventListener('change', async (e) => {
          const selectedType = e.target.value;
          updateBridgeTypeUI(selectedType);
          await updateConfigValue({ bridgeType: selectedType });
          
          // è‡ªåŠ¨ä¸ºå†…ç½®ç±»å‹é…ç½®ç½‘æ¡¥
          if (selectedType === 'snowflake' || selectedType === 'meek-azure') {
            autoConfigureBridge(selectedType);
          }
        });
        
        useBridgesSwitch.addEventListener('change', async (e) => {
          await updateConfigValue({ useBridges: e.target.checked });
          showNotification(e.target.checked ? 'å·²å¯ç”¨ç½‘æ¡¥åŠŸèƒ½' : 'å·²ç¦ç”¨ç½‘æ¡¥åŠŸèƒ½');
        });

        // æ›´æ–°ç½‘æ¡¥ç±»å‹UIæ˜¾ç¤º
        function updateBridgeTypeUI(bridgeType) {
          if (bridgeType === 'obfs4') {
            manualBridgeInput.style.display = 'flex';
            bridgeInfo.style.display = 'none';
          } else {
            manualBridgeInput.style.display = 'none';
            bridgeInfo.style.display = 'block';
          }
        }

        // è‡ªåŠ¨é…ç½®å†…ç½®ç½‘æ¡¥
        async function autoConfigureBridge(bridgeType) {
          try {
            await window.electronAPI.autoConfigureBridge(bridgeType);
            const newConfig = await window.electronAPI.getConfig();
            renderBridgeList(newConfig.bridges || []);
            showNotification(`å·²è‡ªåŠ¨é…ç½® ${bridgeType} ç½‘æ¡¥`);
          } catch (e) {
            showNotification(`é…ç½® ${bridgeType} ç½‘æ¡¥å¤±è´¥: ` + e.message, 'error');
          }
        }// Torè¿æ¥ - è¿™ä¸ªæŒ‰é’®å·²è¢«ç§»é™¤ï¼ŒåŠŸèƒ½é€šè¿‡å¼€å…³å®ç°        // æ˜¾ç¤ºæ—¥å¿—
        document.getElementById('show-log-btn').addEventListener('click', () => {
          // ç›´æ¥æ‰“å¼€Toræ—¥å¿—çª—å£
          window.electronAPI.openTorLog();
        });

        // æ¸…é™¤æ•°æ®
        document.getElementById('clear-data-btn').addEventListener('click', async () => {
          if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æµè§ˆæ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
            try {
              await window.electronAPI.clearData();
              showNotification('æ‰€æœ‰æµè§ˆç—•è¿¹å·²æ¸…é™¤ï¼');
            } catch (e) {
              showNotification('æ¸…é™¤å¤±è´¥: ' + e.message, 'error');
            }
          }
        });

        // æ·»åŠ ç½‘æ¡¥
        document.getElementById('add-bridge-btn').addEventListener('click', async () => {
          const bridgeInput = document.getElementById('bridge-input');
          const bridge = bridgeInput.value.trim();
          
          if (bridge) {
            try {
              await window.electronAPI.addBridge(bridge);
              bridgeInput.value = '';
              showNotification('ç½‘æ¡¥å·²æ·»åŠ ï¼');
              
              // é‡æ–°è·å–é…ç½®å¹¶æ›´æ–°åˆ—è¡¨
              const newConfig = await window.electronAPI.getConfig();
              renderBridgeList(newConfig.bridges || []);
            } catch (e) {
              showNotification('æ·»åŠ ç½‘æ¡¥å¤±è´¥: ' + e.message, 'error');
            }
          }
        });        // æ‰«ç åŠŸèƒ½
        document.getElementById('scan-qr-btn').addEventListener('click', async () => {
          const video = document.getElementById('qr-video');
          
          if (video.classList.contains('active')) {
            // åœæ­¢æ‰«ç 
            stopQRScanner();
          } else {
            // å¼€å§‹æ‰«ç 
            startQRScanner();
          }
        });        // ä¿å­˜ç½‘æ¡¥é…ç½®
        document.getElementById('save-bridge-config-btn').addEventListener('click', async () => {
          try {
            console.log('å¼€å§‹ä¿å­˜ç½‘æ¡¥é…ç½®...');
            const result = await window.electronAPI.saveBridgeConfig();
            console.log('ä¿å­˜ç»“æœ:', result);
            
            if (result) {
              showNotification('ç½‘æ¡¥é…ç½®å·²ä¿å­˜åˆ° torrc æ–‡ä»¶ï¼');
              
              // é‡æ–°ç”Ÿæˆtorrcä»¥ç¡®ä¿é…ç½®ç”Ÿæ•ˆ
              const currentConfig = await window.electronAPI.getConfig();
              console.log('å½“å‰é…ç½®:', currentConfig);
            } else {
              showNotification('ä¿å­˜ç½‘æ¡¥é…ç½®å¤±è´¥', 'error');
            }
          } catch (e) {
            console.error('ä¿å­˜ç½‘æ¡¥é…ç½®å‡ºé”™:', e);
            showNotification('ä¿å­˜ç½‘æ¡¥é…ç½®å¤±è´¥: ' + e.message, 'error');
          }
        });        // é‡ç½®ç½‘æ¡¥é…ç½®
        document.getElementById('reset-bridge-config-btn').addEventListener('click', async () => {
          const bridgeType = document.getElementById('bridge-type').value;
          if (confirm(`ç¡®å®šè¦é‡ç½®ä¸ºå®˜æ–¹ ${bridgeType} ç½‘æ¡¥é…ç½®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
            try {
              const result = await window.electronAPI.resetBridgeConfig(bridgeType);
              showNotification(`ç½‘æ¡¥é…ç½®å·²é‡ç½®ä¸ºå®˜æ–¹ ${bridgeType} é»˜è®¤å€¼ï¼`);
              
              // æ›´æ–°ç•Œé¢
              renderBridgeList(result.bridges || []);
              
              // æ›´æ–°ç½‘æ¡¥ç±»å‹é€‰æ‹©
              document.getElementById('bridge-type').value = result.bridgeType;
              updateBridgeTypeUI(result.bridgeType);
            } catch (e) {
              showNotification('é‡ç½®ç½‘æ¡¥é…ç½®å¤±è´¥: ' + e.message, 'error');
            }
          }
        });        // å¿«é€Ÿè®¾ç½®ä»£ç†
        document.getElementById('quick-clash').addEventListener('click', async () => {
          proxyHost.value = '127.0.0.1:7890';
          const currentConfig = await window.electronAPI.getConfig();
          await updateConfigValue({ 
            proxyConfig: { ...currentConfig.proxyConfig, host: '127.0.0.1:7890' } 
          });
          showNotification('å·²è®¾ç½® Clash é»˜è®¤ç«¯å£ï¼');
        });

        document.getElementById('quick-v2ray').addEventListener('click', async () => {
          proxyHost.value = '127.0.0.1:10809';
          const currentConfig = await window.electronAPI.getConfig();
          await updateConfigValue({ 
            proxyConfig: { ...currentConfig.proxyConfig, host: '127.0.0.1:10809' } 
          });
          showNotification('å·²è®¾ç½® V2Ray é»˜è®¤ç«¯å£ï¼');
        });

      } catch (error) {
        console.error('è®¾ç½®é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
        showNotification('è®¾ç½®é¡µé¢åŠ è½½å¤±è´¥', 'error');
      }
    });

    // æ¸²æŸ“ç½‘æ¡¥åˆ—è¡¨
    function renderBridgeList(bridges) {
      const container = document.getElementById('bridge-list');
      container.innerHTML = '';
      
      if (bridges.length === 0) {
        container.innerHTML = `
          <div class="bridge-item" style="color: var(--text-secondary); text-align: center;">
            æš‚æ— ç½‘æ¡¥é…ç½®
          </div>
        `;
        return;
      }
      
      bridges.forEach(bridge => {
        const item = document.createElement('div');
        item.className = 'bridge-item';
        item.textContent = bridge;
        container.appendChild(item);
      });
    }

    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(message, type = 'success') {
      // åˆ›å»ºé€šçŸ¥å…ƒç´ 
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'error' ? 'var(--accent-secondary)' : 'var(--accent-primary)'};
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px var(--shadow);
        z-index: 10000;
        font-size: 14px;
        font-weight: 500;
        opacity: 0;
        transition: opacity 0.3s ease;
      `;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      // æ˜¾ç¤ºåŠ¨ç”»
      setTimeout(() => {
        notification.style.opacity = '1';
      }, 100);
      
      // è‡ªåŠ¨éšè—
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }

    // QRæ‰«ç ç›¸å…³
    let qrStream = null;
    let qrScanner = null;

    async function startQRScanner() {
      const video = document.getElementById('qr-video');
      const scanBtn = document.getElementById('scan-qr-btn');
      
      try {
        qrStream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' } 
        });
        
        video.srcObject = qrStream;
        video.classList.add('active');
        scanBtn.innerHTML = '<i class="fa-solid fa-stop"></i> åœæ­¢æ‰«ç ';
        
        // è¿™é‡Œéœ€è¦QRæ‰«ç åº“ï¼Œå¦‚æœæ²¡æœ‰å°±ç®€åŒ–å¤„ç†
        showNotification('æ‰«ç åŠŸèƒ½å·²å¯åŠ¨ï¼Œè¯·å°†äºŒç»´ç å¯¹å‡†æ‘„åƒå¤´');
        
      } catch (e) {
        console.error('å¯åŠ¨æ‘„åƒå¤´å¤±è´¥:', e);
        showNotification('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®', 'error');
      }
    }

    function stopQRScanner() {
      const video = document.getElementById('qr-video');
      const scanBtn = document.getElementById('scan-qr-btn');
      
      if (qrStream) {
        qrStream.getTracks().forEach(track => track.stop());
        qrStream = null;
      }
      
      video.classList.remove('active');
      video.srcObject = null;
      scanBtn.innerHTML = '<i class="fa-solid fa-qrcode"></i> æ‰«ç ';
      
      if (qrScanner) {
        qrScanner.stop();
        qrScanner = null;
      }
    }    // æ›´æ–°TorçŠ¶æ€æ˜¾ç¤º
    function updateTorStatus(enabled) {
      const torStatusText = document.getElementById('tor-status-text');
      const torProgressContainer = document.getElementById('tor-progress-container');
      
      if (enabled) {
        torStatusText.textContent = 'Tor æœåŠ¡å·²å¯åŠ¨';
        // å¹³æ»‘éšè—è¿›åº¦æ¡
        torProgressContainer.style.opacity = '0';
        setTimeout(() => {
          torProgressContainer.style.display = 'none';
          torProgressContainer.style.opacity = '1';
        }, 500);
      } else {
        torStatusText.textContent = 'Tor æœåŠ¡å·²æ–­å¼€';
        torProgressContainer.style.display = 'none';
      }
    }// æ›´æ–°Torè¿›åº¦
    function updateTorProgress(percent, text) {
      const progressFill = document.getElementById('tor-progress-fill');
      const progressText = document.getElementById('tor-progress-text');
      
      if (progressFill && progressText) {
        progressFill.style.width = percent + '%';
        progressText.textContent = text;
      }
    }    // å®æ—¶è¯»å–Toræ—¥å¿—å¹¶æ›´æ–°è¿›åº¦    let torConnected = false; // æ·»åŠ è¿æ¥çŠ¶æ€æ ‡å¿—ä½
    async function checkTorProgress() {
      try {
        // å¦‚æœå·²ç»è¿æ¥æˆåŠŸï¼Œä¸å†æ£€æŸ¥è¿›åº¦
        if (torConnected) return;
        
        const logs = await window.electronAPI.readTorLogFile();
        if (logs && Array.isArray(logs) && logs.length > 0) {
          let maxPercent = 0;
          let latestStatus = '';

          logs.forEach(log => {
            if (log.message) {
              const bootstrapMatch = log.message.match(/Bootstrapped (\d+)%.*?:(.*)/);
              if (bootstrapMatch) {
                const percent = parseInt(bootstrapMatch[1]);
                const status = bootstrapMatch[2].trim();
                if (percent >= maxPercent) {
                  maxPercent = percent;
                  latestStatus = status;
                }
              }
            }
          });

          if (maxPercent > 0) {
            const torProgressContainer = document.getElementById('tor-progress-container');
            if (torProgressContainer) {
              torProgressContainer.style.display = 'block';
              updateTorProgress(maxPercent, `æ­£åœ¨è¿æ¥ Tor ç½‘ç»œ... ${maxPercent}% - ${latestStatus}`);
              
              if (maxPercent >= 100 && !torConnected) {
                torConnected = true; // è®¾ç½®è¿æ¥çŠ¶æ€
                // åœæ­¢è¿›åº¦ç›‘æ§
                stopProgressMonitoring();
                // å¹³æ»‘éšè—è¿›åº¦æ¡
                setTimeout(() => {
                  torProgressContainer.style.opacity = '0';
                  setTimeout(() => {
                    torProgressContainer.style.display = 'none';
                    torProgressContainer.style.opacity = '1';
                    updateTorStatus(true);
                    showNotification('Tor è¿æ¥æˆåŠŸï¼');
                  }, 500);
                }, 1000);
              }
            }
          }
        }
      } catch (e) {
        console.error('è¯»å–Toræ—¥å¿—å¤±è´¥:', e);
      }
    }

    // å®šæœŸæ£€æŸ¥Torè¿æ¥è¿›åº¦
    let progressInterval = null;    // å¯åŠ¨Toræ—¶å¼€å§‹ç›‘æ§è¿›åº¦
    function startProgressMonitoring() {
      torConnected = false; // é‡ç½®è¿æ¥çŠ¶æ€
      if (progressInterval) clearInterval(progressInterval);
      progressInterval = setInterval(checkTorProgress, 1000);
    }

    // åœæ­¢ç›‘æ§è¿›åº¦
    function stopProgressMonitoring() {
      if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
      }
    }

    // ç›‘å¬TorçŠ¶æ€å˜åŒ–
    if (window.electronAPI && window.electronAPI.onTorStatus) {
      window.electronAPI.onTorStatus((status) => {
        console.log('æ”¶åˆ°TorçŠ¶æ€æ›´æ–°:', status);
        const torSwitch = document.getElementById('tor-switch');
        if (!status.connected && torSwitch) {
          // Torå·²æ–­å¼€
          torSwitch.checked = false;
          updateTorStatus(false);
          stopProgressMonitoring();
        }      });
    }    // Torrc ç¼–è¾‘å™¨åŠŸèƒ½
    let torrcEditor = null;

    function initTorrcEditor() {
      torrcEditor = document.getElementById('torrc-editor');
      
      if (torrcEditor) {
        // åŠ è½½torrcå†…å®¹
        loadTorrcContent();
        
        // å·¥å…·æ æŒ‰é’®
        document.getElementById('reload-torrc')?.addEventListener('click', loadTorrcContent);
        document.getElementById('save-torrc')?.addEventListener('click', saveTorrcContent);
        document.getElementById('reset-torrc')?.addEventListener('click', resetTorrcContent);
      }
    }

    async function loadTorrcContent() {      try {
        const content = await window.electronAPI.getTorrcContent();
        if (torrcEditor) {
          torrcEditor.value = content || '';
          showNotification('Torrc é…ç½®å·²è½½å…¥');
        }
      } catch (error) {
        console.error('Failed to load torrc:', error);
        showNotification('è½½å…¥ Torrc é…ç½®å¤±è´¥', 'error');
      }
    }

    async function saveTorrcContent() {
      try {
        if (torrcEditor) {
          const content = torrcEditor.value;
          const success = await window.electronAPI.saveTorrcContent(content);
          if (success) {
            showNotification('Torrc é…ç½®å·²ä¿å­˜ï¼Œé‡å¯ Tor åç”Ÿæ•ˆ');
          } else {
            showNotification('ä¿å­˜ Torrc é…ç½®å¤±è´¥', 'error');
          }
        }
      } catch (error) {
        console.error('Failed to save torrc:', error);
        showNotification('ä¿å­˜ Torrc é…ç½®å¤±è´¥', 'error');
      }
    }

    async function resetTorrcContent() {
      if (confirm('ç¡®å®šè¦é‡ç½® Torrc é…ç½®ä¸ºé»˜è®¤å€¼å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
        try {
          // ç”Ÿæˆé»˜è®¤é…ç½®
          const config = await window.electronAPI.getConfig();
          await window.electronAPI.updateConfig(config);
          await loadTorrcContent();
          showNotification('Torrc é…ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼');
        } catch (error) {
          console.error('Failed to reset torrc:', error);
          showNotification('é‡ç½® Torrc é…ç½®å¤±è´¥', 'error');
        }      }
    }

    // ç›‘å¬ä¸»é¢˜å˜æ›´
    if (window.electronAPI && window.electronAPI.onThemeChange) {
      window.electronAPI.onThemeChange((themeData) => {
        applyTheme(themeData.theme);
        
        // æ›´æ–°ä¸»é¢˜é€‰æ‹©
        document.querySelectorAll('input[name="theme"]').forEach(radio => {
          radio.checked = (radio.value === themeData.theme);
        });
        
        // æ›´æ–°ä¸»é¢˜è‰²
        if (themeData.accentColor) {
          updateAccentColor(themeData.accentColor);
        }
      });
    }

    // ç›‘å¬Torè¿›åº¦æ›´æ–°
    if (window.electronAPI && window.electronAPI.onTorLog) {
      window.electronAPI.onTorLog((log) => {
        // è§£æTorå¯åŠ¨è¿›åº¦
        const bootstrapMatch = log.match(/Bootstrapped (\d+)%/);
        if (bootstrapMatch) {
          const percent = parseInt(bootstrapMatch[1]);
          updateTorProgress(percent, `æ­£åœ¨è¿æ¥ Tor ç½‘ç»œ... ${percent}%`);
          
          if (percent === 100) {
            updateTorStatus(true);
            showNotification('Tor è¿æ¥æˆåŠŸï¼');
            stopProgressMonitoring();
          }
        }
      });
    }

    // åˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½
    setTimeout(() => {
      initTorrcEditor();
    }, 100);</script>
</body>
</html>
